<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ETF æŠ˜æº¢åƒ¹ç›£æ§çœ‹æ¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .signal-buy { background-color: #dcfce7; color: #166534; }
    .signal-wait { background-color: #fee2e2; color: #991b1b; }
    .signal-neutral { background-color: #fef3c7; color: #92400e; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <header class="mb-6">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š 2,440 è¬è¨ˆç•«ï¼šETF æŠ˜æº¢åƒ¹ç›£æ§</h1>
          <p class="text-gray-600 mt-2">
            è‡ªå‹•æŠ“å– NAV / å¸‚åƒ¹ï¼Œä¸¦ä¾æŠ˜æº¢åƒ¹çµ¦åŠ ç¢¼ç‡ˆè™Ÿï¼ˆæ¯ 120 ç§’åˆ·æ–°ï¼‰ã€‚
          </p>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnRefresh"
                  class="px-4 py-2 rounded-xl bg-gray-900 text-white hover:bg-gray-800 transition">
            ç«‹å³åˆ·æ–°
          </button>
          <button id="btnClear"
                  class="px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 transition">
            æ¸…é™¤å¿«å–é¡¯ç¤º
          </button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">
          <div class="text-xs text-gray-500">ç‹€æ…‹</div>
          <div id="statusText" class="mt-1 font-bold text-gray-800">ç­‰å¾…ç¬¬ä¸€æ¬¡åˆ·æ–°â€¦</div>
          <div id="statusSub" class="mt-1 text-sm text-gray-500"></div>
        </div>

        <div class="p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">
          <div class="text-xs text-gray-500">æœ€è¿‘æ›´æ–°</div>
          <div id="lastUpdated" class="mt-1 font-bold text-gray-800 mono">--</div>
          <div class="mt-1 text-sm text-gray-500">è³‡æ–™ä¾†æºï¼šMoneyDJï¼ˆNAVï¼‰+ TWSEï¼ˆå³æ™‚å¸‚åƒ¹ï¼Œè‹¥å¯ç”¨ï¼‰</div>
        </div>

        <div class="p-4 bg-white rounded-2xl border border-gray-200 shadow-sm">
          <div class="text-xs text-gray-500">ä¸‹æ¬¡åˆ·æ–°</div>
          <div id="nextRefresh" class="mt-1 font-bold text-gray-800 mono">--</div>
          <div class="mt-1 text-sm text-gray-500">åˆ·æ–°é »ç‡ï¼š120 ç§’</div>
        </div>
      </div>
    </header>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-100 text-gray-700 uppercase text-sm">
            <tr>
              <th class="px-6 py-4">ä»£ç¢¼ / åç¨±</th>
              <th class="px-6 py-4">NAV</th>
              <th class="px-6 py-4">NAV æ—¥æœŸ</th>
              <th class="px-6 py-4">å¸‚åƒ¹</th>
              <th class="px-6 py-4">æŠ˜æº¢åƒ¹ %</th>
              <th class="px-6 py-4">åŠ ç¢¼ç‡ˆè™Ÿ</th>
              <th class="px-6 py-4">ä¾†æº</th>
            </tr>
          </thead>
          <tbody id="etfTable">
            <!-- rows by JS -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
        <h3 class="font-bold text-blue-800 mb-2">ğŸ’¡ ç‡ˆè™Ÿè¦å‰‡ï¼ˆå¯è‡ªè¡Œæ”¹é–€æª»ï¼‰</h3>
        <ul class="text-sm space-y-1 text-blue-900">
          <li><span class="font-bold">æŠ˜åƒ¹ &lt; -0.50%</span>ï¼šå¼·åŠ›åŠ ç¢¼</li>
          <li><span class="font-bold">-0.50% â‰¤ æŠ˜åƒ¹ &lt; -0.10%</span>ï¼šå°å¹…åŠ ç¢¼</li>
          <li><span class="font-bold">-0.10% â‰¤ æŠ˜æº¢åƒ¹ â‰¤ 0.50%</span>ï¼šåˆç†è§€å¯Ÿ</li>
          <li><span class="font-bold">æº¢åƒ¹ &gt; 0.50%</span>ï¼šæº¢åƒ¹é¿é–‹</li>
        </ul>
      </div>

      <div class="p-4 bg-gray-100 border border-gray-200 rounded-xl">
        <h3 class="font-bold text-gray-800 mb-2">ğŸ› ï¸ èªªæ˜</h3>
        <p class="text-sm text-gray-600">
          é€™å€‹é é¢æœƒå‘¼å«åŒä¸€å€‹ Vercel å°ˆæ¡ˆçš„ <span class="mono font-bold">/api/etf</span>ã€‚
          æ‰€ä»¥å‰å°ä¸ç”¨æ”¾ API Keyï¼Œä¹Ÿä¸æœƒé‡åˆ°ç€è¦½å™¨ CORSã€‚
        </p>
        <p class="text-sm text-gray-600 mt-2">
          è‹¥ä½ çœ‹åˆ°ã€ŒTWSE realtimeã€æ‹¿ä¸åˆ°ï¼Œæœƒè‡ªå‹• fallback ç”¨ MoneyDJ çš„å¸‚åƒ¹ï¼ˆbest-effortï¼‰ã€‚
        </p>
      </div>
    </div>
  </div>

  <script>
    // ====== ä½ è¦ç›£æ§çš„ ETF æ¸…å–®ï¼ˆå¯è‡ªè¡Œå¢æ¸›ï¼‰ ======
    const ETFS = [
      { code: '009816', name: 'å‡±åŸºå°ç£TOP50' },
      { code: '00955',  name: 'ä¸­ä¿¡æ—¥æœ¬å•†ç¤¾' },
      { code: '009805', name: 'æ–°å…‰ç¾åœ‹é›»åŠ›åŸºå»º' },
      { code: '00713',  name: 'å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢' },
      { code: '00635U', name: 'æœŸå…ƒå¤§S&Pé»ƒé‡‘' }
    ];

    const REFRESH_MS = 120000;

    // ====== UI helpers ======
    function calculateSignal(premium) {
      if (premium < -0.5) return { text: 'å¼·åŠ›åŠ ç¢¼', class: 'signal-buy' };
      if (premium < -0.1) return { text: 'å°å¹…åŠ ç¢¼', class: 'signal-buy' };
      if (premium <= 0.5) return { text: 'åˆç†è§€å¯Ÿ', class: 'signal-neutral' };
      return { text: 'æº¢åƒ¹é¿é–‹', class: 'signal-wait' };
    }

    function fmtNum(n, digits=2) {
      if (n === null || n === undefined || Number.isNaN(n)) return '--';
      const v = Number(n);
      if (!Number.isFinite(v)) return '--';
      return v.toFixed(digits);
    }

    function fmtPct(n) {
      if (n === null || n === undefined || Number.isNaN(n)) return '--';
      const v = Number(n);
      if (!Number.isFinite(v)) return '--';
      return (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
    }

    function setStatus(main, sub='') {
      document.getElementById('statusText').innerText = main;
      document.getElementById('statusSub').innerText = sub;
    }

    function isoToLocal(iso) {
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        return d.toLocaleString('zh-TW', { hour12: false });
      } catch {
        return iso;
      }
    }

    // ====== render table ======
    const tbody = document.getElementById('etfTable');

    function renderEmpty() {
      tbody.innerHTML = '';
      ETFS.forEach((etf) => {
        const tr = document.createElement('tr');
        tr.className = "border-t border-gray-100";
        tr.innerHTML = `
          <td class="px-6 py-4">
            <div class="font-bold text-gray-900 mono">${etf.code}</div>
            <div class="text-xs text-gray-500">${etf.name}</div>
          </td>
          <td class="px-6 py-4 mono">--</td>
          <td class="px-6 py-4 mono">--</td>
          <td class="px-6 py-4 mono">--</td>
          <td class="px-6 py-4 mono font-bold">--</td>
          <td class="px-6 py-4 text-gray-400">ç­‰å¾…æ•¸æ“š</td>
          <td class="px-6 py-4 text-gray-400">--</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderData(items, byCode) {
      tbody.innerHTML = '';
      ETFS.forEach((etf) => {
        const it = byCode[etf.code] || null;

        const nav = it?.nav ?? null;
        const navDate = it?.navDate ?? null;
        const price = it?.price ?? null;
        const premium = it?.premiumPct ?? null;

        const signal = (typeof premium === 'number')
          ? calculateSignal(premium)
          : { text: 'ç­‰å¾…æ•¸æ“š', class: '' };

        const sourceText = [
          it?.priceFrom ? `å¸‚åƒ¹ï¼š${it.priceFrom}` : null,
          it?.premiumFrom ? `æŠ˜æº¢åƒ¹ï¼š${it.premiumFrom}` : null
        ].filter(Boolean).join('ï¼›') || '--';

        const moneydjUrl = it?.moneydjUrl || null;

        const tr = document.createElement('tr');
        tr.className = "border-t border-gray-100 hover:bg-gray-50 transition";
        tr.innerHTML = `
          <td class="px-6 py-4">
            <div class="font-bold text-gray-900 mono">${etf.code}</div>
            <div class="text-xs text-gray-500">${etf.name}</div>
            ${moneydjUrl ? `<a class="text-xs text-blue-600 underline" target="_blank" href="${moneydjUrl}">MoneyDJ</a>` : ''}
          </td>

          <td class="px-6 py-4 mono">${fmtNum(nav, 2)}</td>
          <td class="px-6 py-4 mono">${navDate || '--'}</td>
          <td class="px-6 py-4 mono">${fmtNum(price, 2)}</td>
          <td class="px-6 py-4 mono font-bold">${fmtPct(premium)}</td>

          <td class="px-6 py-4 font-bold ${signal.class}">
            ${signal.text}
          </td>

          <td class="px-6 py-4 text-xs text-gray-600">
            ${sourceText}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ====== fetch & refresh ======
    let timer = null;
    let nextTick = null;

    function updateNextRefreshUI() {
      if (!nextTick) {
        document.getElementById('nextRefresh').innerText = '--';
        return;
      }
      const now = Date.now();
      const left = Math.max(0, nextTick - now);
      const sec = Math.ceil(left / 1000);
      const mm = String(Math.floor(sec / 60)).padStart(2, '0');
      const ss = String(sec % 60).padStart(2, '0');
      document.getElementById('nextRefresh').innerText = `${mm}:${ss}`;
    }

    async function refresh() {
      const codes = ETFS.map(x => x.code).join(',');
      const url = `/api/etf?codes=${encodeURIComponent(codes)}`;

      setStatus('åˆ·æ–°ä¸­â€¦', url);

      try {
        const r = await fetch(url, { cache: "no-store" });
        const j = await r.json();

        if (!r.ok || !j?.ok) {
          throw new Error(j?.error ? `${j.error}${j.message ? ' - ' + j.message : ''}` : `HTTP ${r.status}`);
        }

        document.getElementById('lastUpdated').innerText = isoToLocal(j.updatedAt || new Date().toISOString());
        renderData(j.items || [], j.byCode || {});
        setStatus('âœ… æ­£å¸¸', j.source || '');

        // schedule next
        nextTick = Date.now() + REFRESH_MS;
      } catch (e) {
        setStatus('âš ï¸ åˆ·æ–°å¤±æ•—', String(e?.message || e));
      }
    }

    function startAutoRefresh() {
      if (timer) clearInterval(timer);
      // countdown UI update every 1s
      timer = setInterval(updateNextRefreshUI, 1000);

      // refresh loop
      setInterval(() => refresh(), REFRESH_MS);
      nextTick = Date.now() + REFRESH_MS;
    }

    // ====== actions ======
    document.getElementById('btnRefresh').addEventListener('click', async () => {
      await refresh();
      nextTick = Date.now() + REFRESH_MS;
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      renderEmpty();
      document.getElementById('lastUpdated').innerText = '--';
      setStatus('å·²æ¸…ç©ºé¡¯ç¤º', 'æŒ‰ã€Œç«‹å³åˆ·æ–°ã€é‡æ–°æŠ“å–');
    });

    // init
    renderEmpty();
    refresh();
    startAutoRefresh();
  </script>
</body>
</html>

</body>
</html>

