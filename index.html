<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ETF æŠ˜æº¢åƒ¹ç›£æ§çœ‹æ¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .signal-buy { background-color: #dcfce7; color: #166534; }
    .signal-wait { background-color: #fee2e2; color: #991b1b; }
    .signal-neutral { background-color: #fef3c7; color: #92400e; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <header class="mb-5">
      <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š 2,440 è¬è¨ˆç•«ï¼šETF æŠ˜æº¢åƒ¹ç›£æ§</h1>
      <p class="text-gray-600 mt-2">ç›¤ä¸­ 120 ç§’åˆ·æ–°ï¼›ç›¤å¤–è‡ªå‹•æ”¾æ…¢ã€‚è³‡æ–™æºï¼šWantGooï¼ˆç¬¬ä¸‰æ–¹ï¼‰</p>

      <div class="mt-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="text-sm text-gray-600">
          æœ€å¾Œæ›´æ–°ï¼š<span id="lastUpdated" class="font-mono text-gray-800">--</span>
          <span id="marketBadge" class="ml-2 px-2 py-1 rounded-full text-xs bg-gray-200 text-gray-700">--</span>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <button id="refreshBtn"
            class="px-3 py-2 rounded-lg bg-white border border-gray-200 shadow-sm hover:bg-gray-50 text-sm">
            æ‰‹å‹•åˆ·æ–°
          </button>

          <button id="toggleManualBtn"
            class="px-3 py-2 rounded-lg bg-white border border-gray-200 shadow-sm hover:bg-gray-50 text-sm">
            å…è¨±æ‰‹å‹•è¦†å¯«ï¼šé—œ
          </button>

          <button id="resetBtn"
            class="px-3 py-2 rounded-lg bg-white border border-gray-200 shadow-sm hover:bg-gray-50 text-sm text-red-600">
            æ¸…é™¤è¦†å¯«
          </button>
        </div>
      </div>

      <div id="statusBar" class="mt-3 hidden">
        <div id="statusText" class="text-sm px-3 py-2 rounded-lg border"></div>
      </div>
    </header>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
      <table class="w-full text-left border-collapse">
        <thead class="bg-gray-100 text-gray-700 uppercase text-sm">
          <tr>
            <th class="px-6 py-4">ä»£ç¢¼ / åç¨±</th>
            <th class="px-6 py-4">æ·¨å€¼ (NAV)</th>
            <th class="px-6 py-4">å¸‚åƒ¹</th>
            <th class="px-6 py-4">æŠ˜æº¢åƒ¹ %</th>
            <th class="px-6 py-4">åŠ ç¢¼ç‡ˆè™Ÿ</th>
          </tr>
        </thead>
        <tbody id="etfTable"></tbody>
      </table>
    </div>

    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
        <h3 class="font-bold text-blue-800 mb-2">ğŸ’¡ ç‡ˆè™Ÿè¦å‰‡ï¼ˆå¯è‡ªè¡Œæ”¹é–€æª»ï¼‰</h3>
        <ul class="text-sm space-y-1 text-blue-900/90">
          <li>æŠ˜æº¢åƒ¹ &lt; -0.50%ï¼šå¼·åŠ›åŠ ç¢¼</li>
          <li>-0.50% â‰¤ æŠ˜æº¢åƒ¹ &lt; -0.10%ï¼šå°å¹…åŠ ç¢¼</li>
          <li>-0.10% â‰¤ æŠ˜æº¢åƒ¹ â‰¤ 0.50%ï¼šåˆç†è§€å¯Ÿ</li>
          <li>æŠ˜æº¢åƒ¹ &gt; 0.50%ï¼šæº¢åƒ¹é¿é–‹</li>
        </ul>
      </div>

      <div class="p-4 bg-gray-100 border border-gray-200 rounded-xl">
        <h3 class="font-bold text-gray-800 mb-2">ğŸ› ï¸ å‚™è¨»</h3>
        <p class="text-sm text-gray-700">
          ç›¤ä¸­æ¯ 120 ç§’è‡ªå‹•æ›´æ–°ã€‚è‹¥ WantGoo æ”¹ç‰ˆæˆ–æš«æ™‚å°é–é »ç‡ï¼Œå¯èƒ½æœƒé¡¯ç¤ºéŒ¯èª¤æç¤ºã€‚
          ä½ ä»å¯é–‹å•Ÿã€Œå…è¨±æ‰‹å‹•è¦†å¯«ã€è‡ªè¡Œå¡«å€¼è¨ˆç®—æŠ˜æº¢åƒ¹ã€‚
        </p>
      </div>
    </div>
  </div>

  <script>
    // ===== ä½ çš„è¿½è¹¤æ¸…å–®ï¼ˆä¾ä½ ç›®å‰åº«å­˜ï¼‰=====
    const etfs = [
      { code: '009816', name: 'å‡±åŸºå°ç£TOP50' },
      { code: '00955',  name: 'ä¸­ä¿¡æ—¥æœ¬å•†ç¤¾' },
      { code: '009805', name: 'æ–°å…‰ç¾åœ‹é›»åŠ›åŸºå»º' },
      { code: '00713',  name: 'å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢' },
      { code: '00635U', name: 'æœŸå…ƒå¤§S&Pé»ƒé‡‘' },
    ];

    // localStorageï¼ˆæ‰‹å‹•è¦†å¯«ç”¨ï¼‰
    const OVERRIDE_KEY = "etf_dash_overrides_v1";

    // UI ç‹€æ…‹
    let manualEnabled = false;
    let inFlight = false;
    let timer = null;

    function showStatus(kind, msg) {
      const bar = document.getElementById('statusBar');
      const box = document.getElementById('statusText');
      bar.classList.remove('hidden');

      if (kind === 'ok') {
        box.className = "text-sm px-3 py-2 rounded-lg border border-green-200 bg-green-50 text-green-800";
      } else if (kind === 'warn') {
        box.className = "text-sm px-3 py-2 rounded-lg border border-yellow-200 bg-yellow-50 text-yellow-800";
      } else {
        box.className = "text-sm px-3 py-2 rounded-lg border border-red-200 bg-red-50 text-red-800";
      }
      box.textContent = msg;
    }

    function hideStatus() {
      document.getElementById('statusBar').classList.add('hidden');
    }

    function calculateSignal(premium) {
      if (premium < -0.5) return { text: 'å¼·åŠ›åŠ ç¢¼', class: 'signal-buy' };
      if (premium < -0.1) return { text: 'å°å¹…åŠ ç¢¼', class: 'signal-buy' };
      if (premium <= 0.5) return { text: 'åˆç†è§€å¯Ÿ', class: 'signal-neutral' };
      return { text: 'æº¢åƒ¹é¿é–‹', class: 'signal-wait' };
    }

    function getOverrides() {
      try { return JSON.parse(localStorage.getItem(OVERRIDE_KEY) || "{}"); }
      catch { return {}; }
    }

    function setOverrides(obj) {
      localStorage.setItem(OVERRIDE_KEY, JSON.stringify(obj));
    }

    function clearOverrides() {
      localStorage.removeItem(OVERRIDE_KEY);
    }

    function num(x) {
      const v = Number(x);
      return Number.isFinite(v) ? v : null;
    }

    function premiumPct(price, nav) {
      if (!(price > 0 && nav > 0)) return null;
      return ((price - nav) / nav) * 100;
    }

    function setManualEnabled(enabled) {
      manualEnabled = enabled;

      document.getElementById('toggleManualBtn').textContent = `å…è¨±æ‰‹å‹•è¦†å¯«ï¼š${manualEnabled ? 'é–‹' : 'é—œ'}`;

      // input æ¬Šé™
      etfs.forEach(etf => {
        const p = document.getElementById(`price-${etf.code}`);
        const n = document.getElementById(`nav-${etf.code}`);
        if (!p || !n) return;
        p.readOnly = !manualEnabled;
        n.readOnly = !manualEnabled;

        p.classList.toggle('bg-gray-50', !manualEnabled);
        n.classList.toggle('bg-gray-50', !manualEnabled);
      });

      showStatus('warn',
        manualEnabled
          ? 'å·²é–‹å•Ÿæ‰‹å‹•è¦†å¯«ï¼šä½ å¯è‡ªè¡Œæ”¹ NAV/å¸‚åƒ¹ï¼ˆæœƒå­˜åˆ°æœ¬æ©Ÿç€è¦½å™¨ï¼‰ã€‚'
          : 'å·²é—œé–‰æ‰‹å‹•è¦†å¯«ï¼šæ•¸å€¼ä»¥è‡ªå‹•æŠ“å–ç‚ºä¸»ã€‚'
      );
      setTimeout(hideStatus, 1800);
    }

    function updateRow(code) {
      const priceEl = document.getElementById(`price-${code}`);
      const navEl   = document.getElementById(`nav-${code}`);
      const diffEl  = document.getElementById(`diff-${code}`);
      const sigEl   = document.getElementById(`signal-${code}`);

      const price = num(priceEl?.value);
      const nav   = num(navEl?.value);

      const prem = premiumPct(price, nav);
      if (prem === null) {
        diffEl.textContent = '--';
        diffEl.className = "px-6 py-4 font-mono font-bold text-gray-500";
        sigEl.textContent = 'ç­‰å¾…æ•¸æ“š';
        sigEl.className = "px-6 py-4 text-gray-400";
        return;
      }

      diffEl.textContent = prem.toFixed(2) + '%';
      diffEl.className = "px-6 py-4 font-mono font-bold " + (prem < 0 ? "text-green-700" : "text-red-700");

      const sig = calculateSignal(prem);
      sigEl.textContent = sig.text;
      sigEl.className = `px-6 py-4 font-bold ${sig.class}`;
    }

    function saveOverride(code) {
      const o = getOverrides();
      o[code] = {
        price: document.getElementById(`price-${code}`)?.value ?? "",
        nav: document.getElementById(`nav-${code}`)?.value ?? ""
      };
      setOverrides(o);
    }

    function loadOverridesIntoInputs() {
      const o = getOverrides();
      for (const [code, v] of Object.entries(o)) {
        const p = document.getElementById(`price-${code}`);
        const n = document.getElementById(`nav-${code}`);
        if (p && typeof v.price !== 'undefined') p.value = v.price;
        if (n && typeof v.nav !== 'undefined') n.value = v.nav;
        updateRow(code);
      }
    }

    // ===== Taipei ç›¤ä¸­åˆ¤æ–·ï¼ˆä¸ä¾è³´ä½¿ç”¨è€…æ‰€åœ¨åœ°æ™‚å€ï¼‰=====
    function taipeiParts() {
      const fmt = new Intl.DateTimeFormat('en-GB', {
        timeZone: 'Asia/Taipei',
        weekday: 'short',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
      });
      const parts = fmt.formatToParts(new Date());
      const obj = {};
      for (const p of parts) obj[p.type] = p.value;
      return {
        weekday: obj.weekday, // Mon/Tue/...
        hour: Number(obj.hour),
        minute: Number(obj.minute),
      };
    }

    function isMarketHoursTW() {
      const { weekday, hour, minute } = taipeiParts();
      const wd = (weekday || '').toLowerCase();
      if (wd.startsWith('sat') || wd.startsWith('sun')) return false;

      const mins = hour * 60 + minute;
      const open = 8 * 60 + 55;   // 08:55
      const close = 13 * 60 + 35; // 13:35
      return mins >= open && mins <= close;
    }

    function updateMarketBadge() {
      const badge = document.getElementById('marketBadge');
      if (isMarketHoursTW()) {
        badge.textContent = 'ç›¤ä¸­ï¼ˆ120 ç§’åˆ·æ–°ï¼‰';
        badge.className = 'ml-2 px-2 py-1 rounded-full text-xs bg-green-100 text-green-800';
      } else {
        badge.textContent = 'ç›¤å¤–ï¼ˆ30 åˆ†é˜åˆ·æ–°ï¼‰';
        badge.className = 'ml-2 px-2 py-1 rounded-full text-xs bg-gray-200 text-gray-700';
      }
    }

    // ===== Render table =====
    const tbody = document.getElementById('etfTable');
    etfs.forEach(etf => {
      const tr = document.createElement('tr');
      tr.className = "border-t border-gray-100 hover:bg-gray-50 transition";

      tr.innerHTML = `
        <td class="px-6 py-4">
          <div class="font-bold text-gray-800">${etf.code}</div>
          <div class="text-xs text-gray-500">${etf.name}</div>
        </td>

        <td class="px-6 py-4">
          <input id="nav-${etf.code}" type="number" step="0.01" placeholder="--"
            class="w-28 p-1 border rounded bg-gray-50"
            readonly />
        </td>

        <td class="px-6 py-4">
          <input id="price-${etf.code}" type="number" step="0.01" placeholder="--"
            class="w-28 p-1 border rounded bg-gray-50"
            readonly />
        </td>

        <td class="px-6 py-4 font-mono font-bold text-gray-500" id="diff-${etf.code}">--</td>
        <td class="px-6 py-4 text-gray-400" id="signal-${etf.code}">ç­‰å¾…æ•¸æ“š</td>
      `;

      tbody.appendChild(tr);

      // æ‰‹å‹•è¦†å¯«æ™‚ï¼Œè®Šæ›´å°±å­˜æª” + æ›´æ–°ç‡ˆè™Ÿ
      const navEl = tr.querySelector(`#nav-${etf.code}`);
      const priceEl = tr.querySelector(`#price-${etf.code}`);
      navEl.addEventListener('input', () => {
        if (manualEnabled) { saveOverride(etf.code); updateRow(etf.code); }
      });
      priceEl.addEventListener('input', () => {
        if (manualEnabled) { saveOverride(etf.code); updateRow(etf.code); }
      });
    });

    // ===== Fetch / API =====
    async function refresh() {
      if (inFlight) return;
      inFlight = true;

      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.classList.add('opacity-60');

      try {
        updateMarketBadge();

        const codes = etfs.map(e => e.code).join(',');
        const r = await fetch(`/api/etf?codes=${encodeURIComponent(codes)}`, { cache: 'no-store' });

        if (!r.ok) throw new Error(`API å¤±æ•—ï¼š${r.status} ${r.statusText}`);
        const data = await r.json();

        const ts = new Date(data.asOf || Date.now());
        document.getElementById('lastUpdated').textContent =
          ts.toLocaleString('zh-TW', { hour12: false });

        // è‹¥ä½ é–‹äº†æ‰‹å‹•è¦†å¯«ï¼Œå°±ä¸è¦è“‹æ‰ä½ æ‰‹å‹•è¼¸å…¥çš„å€¼
        const overrides = getOverrides();

        (data.items || []).forEach(item => {
          const code = item.code;
          if (!code) return;

          const navEl = document.getElementById(`nav-${code}`);
          const priceEl = document.getElementById(`price-${code}`);

          const hasOverride = manualEnabled && overrides[code] && (
            (overrides[code].nav ?? '') !== '' || (overrides[code].price ?? '') !== ''
          );

          if (!hasOverride) {
            if (navEl) navEl.value = (item.nav ?? '') === null ? '' : item.nav ?? '';
            if (priceEl) priceEl.value = (item.price ?? '') === null ? '' : item.price ?? '';
          }

          updateRow(code);
        });

        hideStatus();
      } catch (e) {
        showStatus('err', `æ›´æ–°å¤±æ•—ï¼š${e.message || e}`);
      } finally {
        btn.disabled = false;
        btn.classList.remove('opacity-60');
        inFlight = false;
      }
    }

    // ===== Scheduler: ç›¤ä¸­ 120 ç§’ / ç›¤å¤– 30 åˆ†é˜ =====
    async function tick() {
      await refresh();
      const nextMs = isMarketHoursTW() ? 120000 : 1800000;
      timer = setTimeout(tick, nextMs);
    }

    // ===== Buttons =====
    document.getElementById('refreshBtn').addEventListener('click', refresh);

    document.getElementById('toggleManualBtn').addEventListener('click', () => {
      setManualEnabled(!manualEnabled);
      if (manualEnabled) loadOverridesIntoInputs();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      clearOverrides();
      showStatus('ok', 'å·²æ¸…é™¤æ‰‹å‹•è¦†å¯«ã€‚');
      setTimeout(hideStatus, 1400);
      if (manualEnabled) loadOverridesIntoInputs();
      refresh();
    });

    // init
    updateMarketBadge();
    loadOverridesIntoInputs(); // è‹¥ä¹‹å‰æœ‰è¦†å¯«ï¼Œå…ˆè¼‰å…¥ï¼ˆä½†ä»ç¶­æŒ manual é—œï¼Œé¿å…èª¤è§¸ï¼‰
    tick();
  </script>
</body>
</html>

